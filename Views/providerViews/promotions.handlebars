<div class="container-fluid" style="padding: 0;">
    <div class="row" style="margin: 0;">
        {{> partnerSidebar}}
        
        <div class="col-md-9" style="padding: 20px;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Chương trình khuyến mãi</h2>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPromotionModal">
                    + Thêm mới
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Mã khuyến mãi</th>
                            <th>Tiêu đề</th>
                            <th>Từ ngày</th>
                            <th>Đến ngày</th>
                            <th>Áp dụng tour</th>
                            <th>Mức giảm giá</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each promotions}}
                        <tr>
                            <td>{{code}}</td>
                            <td>{{title}}</td>
                            <td>{{formatDate start_date}}</td>
                            <td>{{formatDate end_date}}</td>
                            <td>{{tour_name}}</td>
                            <td>{{discount_percent}}%</td>
                            <td>
                                <button class="btn btn-sm btn-info mr-2" onclick="editPromotion('{{id}}')">Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="deletePromotion('{{id}}')">Xóa</button>
                            </td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="7" class="text-center">Chưa có khuyến mãi nào</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm khuyến mãi -->
<div class="modal fade" id="addPromotionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm chương trình khuyến mãi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addPromotionForm">
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label>Mã khuyến mãi</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Tiêu đề</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Từ ngày</label>
                        <input type="date" class="form-control" name="start_date" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Đến ngày</label>
                        <input type="date" class="form-control" name="end_date" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Áp dụng dịch vụ</label>
                        <input type="text" class="form-control" name="tour_id" required placeholder="Nhập mã tour">
                    </div>
                    <div class="form-group mb-3">
                        <label>Mức giảm giá (%)</label>
                        <input type="number" class="form-control" name="discount_percent" min="0" max="100" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Sửa Khuyến Mãi -->
<div class="modal fade" id="editPromotionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sửa Khuyến Mãi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editPromotionForm">
                <input type="hidden" name="promotion_id" id="edit_promotion_id">
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label>Mã khuyến mãi</label>
                        <input type="text" class="form-control" name="code" id="edit_code" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Tiêu đề</label>
                        <input type="text" class="form-control" name="title" id="edit_title" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Mã Tour</label>
                        <input type="text" class="form-control" name="tour_id" id="edit_tour_id" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Từ ngày</label>
                        <input type="date" class="form-control" name="start_date" id="edit_start_date" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Đến ngày</label>
                        <input type="date" class="form-control" name="end_date" id="edit_end_date" required>
                    </div>
                    <div class="form-group mb-3">
                        <label>Mức giảm giá (%)</label>
                        <input type="number" class="form-control" name="discount_percent" id="edit_discount_percent" min="0" max="100" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Thêm jQuery và Bootstrap JS trước khi đóng body -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug: Kiểm tra jQuery
    if (typeof jQuery !== 'undefined') {
        console.log('jQuery is loaded');
    } else {
        console.log('jQuery is not loaded');
    }

    // Sử dụng jQuery sau khi đã load
    $(document).ready(function() {
        console.log('Document ready');
        
        $('#addPromotionForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                code: $('input[name="code"]').val().trim(),
                title: $('input[name="title"]').val().trim(),
                tour_id: $('input[name="tour_id"]').val().trim(),
                discount_percent: $('input[name="discount_percent"]').val(),
                start_date: $('input[name="start_date"]').val(),
                end_date: $('input[name="end_date"]').val()
            };
            
            console.log('Sending data:', formData);

            $.ajax({
                url: '/partner/promotions/add',
                method: 'POST',
                data: formData,
                success: function(response) {
                    console.log('Success response:', response);
                    if (response.success) {
                        alert('Thêm khuyến mãi thành công!');
                        $('#addPromotionModal').modal('hide');
                        window.location.reload();
                    } else {
                        alert('Có lỗi xảy ra: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error details:', {
                        status: status,
                        response: xhr.responseText,
                        error: error
                    });
                    alert('Có lỗi xảy ra khi thêm khuyến mãi: ' + (xhr.responseText || error));
                }
            });
        });
    });
});

// Xử lý sửa khuyến mãi
function editPromotion(id) {
    $.get(`/partner/promotions/${id}`, function(response) {
        if (response.success) {
            const promotion = response.data;
            $('#edit_promotion_id').val(promotion.id);
            $('#edit_code').val(promotion.code);
            $('#edit_title').val(promotion.title);
            $('#edit_tour_id').val(promotion.tour_id);
            $('#edit_discount_percent').val(promotion.discount_percent);
            $('#edit_start_date').val(promotion.start_date.split('T')[0]);
            $('#edit_end_date').val(promotion.end_date.split('T')[0]);
            $('#editPromotionModal').modal('show');
        } else {
            alert('Không thể lấy thông tin khuyến mãi');
        }
    });
}

$('#editPromotionForm').on('submit', function(e) {
    e.preventDefault();
    const id = $('#edit_promotion_id').val();
    const formData = {
        code: $('#edit_code').val(),
        title: $('#edit_title').val(),
        tour_id: $('#edit_tour_id').val(),
        discount_percent: $('#edit_discount_percent').val(),
        start_date: $('#edit_start_date').val(),
        end_date: $('#edit_end_date').val()
    };

    $.ajax({
        url: `/partner/promotions/${id}`,
        method: 'PUT',
        data: formData,
        success: function(response) {
            if (response.success) {
                alert('Cập nhật khuyến mãi thành công!');
                $('#editPromotionModal').modal('hide');
                location.reload();
            } else {
                alert('Có lỗi xảy ra: ' + response.message);
            }
        },
        error: function(xhr) {
            alert('Có lỗi xảy ra khi cập nhật khuyến mãi');
        }
    });
});

// Xử lý xóa khuyến mãi
function deletePromotion(id) {
    if (confirm('Bạn có chắc chắn muốn xóa khuyến mãi này?')) {
        $.ajax({
            url: `/partner/promotions/${id}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    alert('Xóa khuyến mãi thành công!');
                    location.reload();
                } else {
                    alert('Có lỗi xảy ra: ' + response.message);
                }
            },
            error: function(xhr) {
                alert('Có lỗi xảy ra khi xóa khuyến mãi');
            }
        });
    }
}
</script> 